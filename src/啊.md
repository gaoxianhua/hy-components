<template>
  <view>
    <template v-for="item in 2">
      <view class="u-swipe-action-item" ref="u-swipe-action-item">
        <view class="u-swipe-action-item__right">
          <slot name="button">
            <view
              v-for="(item, index) in options"
              :key="index"
              class="u-swipe-action-item__right__button"
              :ref="`u-swipe-action-item__right__button-${index}`"
              :style="[
                {
                  alignItems:
                    item.style && item.style.borderRadius
                      ? 'center'
                      : 'stretch',
                },
              ]"
              @tap="buttonClickHandler(item, index)"
            >
              <view
                class="u-swipe-action-item__right__button__wrapper"
                :style="[
                  {
                    backgroundColor:
                      item.style && item.style.backgroundColor
                        ? item.style.backgroundColor
                        : '#C7C6CD',
                    borderRadius:
                      item.style && item.style.borderRadius
                        ? item.style.borderRadius
                        : '0',
                    padding:
                      item.style && item.style.borderRadius ? '0' : '0 15px',
                  },
                  item.style,
                ]"
              >
                <u-icon
                  v-if="item.icon"
                  :name="item.icon"
                  :color="
                    item.style && item.style.color
                      ? item.style.color
                      : '#ffffff'
                  "
                  :size="
                    item.iconSize
                      ? addUnit(item.iconSize)
                      : item.style && item.style.fontSize
                        ? getPx(item.style.fontSize) * 1.2
                        : 17
                  "
                  :customStyle="{
                    marginRight: item.text ? '2px' : 0,
                  }"
                ></u-icon>
                <text
                  v-if="item.text"
                  class="u-swipe-action-item__right__button__wrapper__text u-line-1"
                  :style="[
                    {
                      color:
                        item.style && item.style.color
                          ? item.style.color
                          : '#ffffff',
                      fontSize:
                        item.style && item.style.fontSize
                          ? item.style.fontSize
                          : '16px',
                      lineHeight:
                        item.style && item.style.fontSize
                          ? item.style.fontSize
                          : '16px',
                    },
                  ]"
                  >{{ item.text }}</text
                >
              </view>
            </view>
          </slot>
        </view>
        <!-- #ifdef APP-VUE || MP-WEIXIN || MP-QQ || H5  -->
        <view
          class="u-swipe-action-item__content"
          @touchstart="handleTouchStart"
          @touchmove="handleTouchMove"
          @touchend="handleTouchEnd"
          :status="status"
          :change:status="setStatus"
          :size="size"
        >
          <slot></slot>
        </view>
        <!-- #endif -->
      </view>
    </template>
  </view>
</template>

<!-- #ifdef APP-VUE || MP-WEIXIN || MP-QQ || H5 -->
<!--<script src="./index.wxs" module="wxs" lang="wxs"></script>-->
<!--<script lang="ts">-->
<!--import wxs from "./wxs.js";-->
<!--</script>-->
<!-- #endif -->

<!--<script lang="ts"></script>-->

<script setup lang="ts">
import type IProps from "./typing";
import defaultProps from "./props";
import { computed, onMounted, ref, toRefs, watch } from "vue";
// #ifdef APP-VUE || MP-WEIXIN || MP-QQ || H5
import { getRect, sleep, addUnit, getPx } from "@/package";
// #endif

const props = withDefaults(defineProps<IProps>(), defaultProps);
const {
  show,
  disabled,
  autoClose,
  threshold,
  options,
  duration,
  closeOnClick,
} = toRefs(props);
const emit = defineEmits(["update:show", "click"]);

type OpenStatus = "open" | "close" | "";

// 按钮的尺寸信息
const size = ref({});
const sliderStyle = ref({});
// 当前状态，open-打开，close-关闭
const status = ref<OpenStatus>("");

watch(
  () => status.value,
  (newValue: OpenStatus) => {
    if (newValue === "open") {
      emit("update:show", true);
    } else {
      emit("update:show", false);
    }
  },
);

watch(
  () => show.value,
  (newValue: boolean) => {
    if (newValue) {
      status.value = "open";
    } else {
      status.value = "close";
    }
  },
);

const wxsInit = computed(() => {
  return [
    disabled.value,
    autoClose.value,
    threshold.value,
    options.value,
    duration.value,
  ];
});

onMounted(() => {
  init();
});

const init = () => {
  // 初始化父组件数据
  updateParentData();
  // #ifndef APP-NVUE
  sleep().then(() => {
    queryRect();
  });
  // #endif
};

const updateParentData = () => {
  // 此方法在mixin中
  // getParentData("u-swipe-action");
};

const queryRect = () => {
  getRect(".u-swipe-action-item__right__button", true).then((buttons) => {
    size.value = {
      buttons,
      show: show.value,
      disabled: disabled.value,
      threshold: threshold.value,
      duration: duration.value,
    };
  });
};

/**
 * @description 按钮被点击
 */
const buttonClickHandler = (item, index: number) => {
  emit(
    "click",
    {
      item,
      index,
    },
    () => {},
  );
  if (closeOnClick.value) {
    closeHandler();
  }
};

const closeHandler = () => {};

const translateX = ref(0);
const buttonsWidth = ref(0);
const startX = ref(0);
const startY = ref(0);
const moving = ref(false);

const getButtonsWidth = () => {
  const buttons = props.buttons;
  let width = 0;
  buttons.forEach((button: any) => {
    width += button.width || 0;
  });
  buttonsWidth.value = width;
};

const handleTouchStart = (event: TouchEvent) => {
  if (props.disabled) return;
  const touches = event.touches;
  if (touches.length > 1) return;
  startX.value = touches[0].pageX;
  startY.value = touches[0].pageY;
  moving.value = true;
};

const handleTouchMove = (event: TouchEvent) => {
  if (!moving.value || props.disabled) return;
  const touches = event.touches;
  if (!touches.length) return;
  const pageX = touches[0].pageX;
  const pageY = touches[0].pageY;
  let moveX = pageX - startX.value;
  const moveY = pageY - startY.value;

  if (Math.abs(moveX) > Math.abs(moveY) || Math.abs(moveX) > props.threshold) {
    event.preventDefault();
    event.stopPropagation();
  }

  if (Math.abs(moveX) < Math.abs(moveY)) return;

  if (status.value === "open") {
    if (moveX < 0) moveX = 0;
    if (moveX > buttonsWidth.value) moveX = buttonsWidth.value;
    moveSwipeAction(-buttonsWidth.value + moveX);
  } else {
    if (moveX > 0) moveX = 0;
    if (Math.abs(moveX) > buttonsWidth.value) moveX = -buttonsWidth.value;
    moveSwipeAction(moveX);
  }
};

const handleTouchEnd = () => {
  if (!moving.value || props.disabled) return;
  const moveX = translateX.value;
  if (status.value === "open") {
    if (moveX === 0) {
      closeSwipeAction();
    } else if (Math.abs(moveX) < props.threshold) {
      openSwipeAction();
    } else {
      closeSwipeAction();
    }
  } else {
    if (Math.abs(moveX) < props.threshold) {
      closeSwipeAction();
    } else {
      openSwipeAction();
    }
  }
};

const moveSwipeAction = (moveX: number) => {
  translateX.value = moveX;
};

const openSwipeAction = () => {
  translateX.value = -buttonsWidth.value;
  status.value = "open";
  emit("open");
};

const closeSwipeAction = () => {
  translateX.value = 0;
  status.value = "close";
  emit("close");
};

const setStatus = (newStatus: string) => {
  if (newStatus === status.value) return;
  status.value = newStatus;
};
</script>

<style scoped lang="scss">
@import "../../libs/css/mixin.scss";

.u-swipe-action-item {
  position: relative;
  overflow: hidden;
  /* #ifndef APP-NVUE || MP-WEIXIN */
  touch-action: pan-y;
  /* #endif */

  &__content {
    transform: translateX(0px); // 修复某些情况下默认右侧按钮是展开的问题
    background-color: #ffffff;
    z-index: 10;
  }

  &__right {
    position: absolute;
    top: 0;
    bottom: 0;
    right: 0;
    @include flex;

    &__button {
      @include flex;
      justify-content: center;
      overflow: hidden;
      align-items: center;

      &__wrapper {
        @include flex;
        align-items: center;
        justify-content: center;
        padding: 0 15px;

        &__text {
          @include flex;
          align-items: center;
          color: #ffffff;
          font-size: 15px;
          text-align: center;
          justify-content: center;
        }
      }
    }
  }
}
</style>
